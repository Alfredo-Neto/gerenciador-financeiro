<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <link rel="stylesheet" href="styles.css"> -->
    <link rel="stylesheet" href="common.css">
    <title>Document</title>
  </head>
  <body>
    <style>
    </style>

    <div class="flexcontainer">
        <div>
            <h1>MOVIMENTOS</h1>
        </div>
        <div>
            <!-- <button class="btn btn-green" onclick="toggleFormNovoMovimento()">Novo</button> -->
        </div>
    </div>

    <div id="divListaMovimentos"></div>
    <script>
        // dado que voce recebeu o contaId pela querystring
        // /movimentos?contaId=4 por exemplo
        // pegue essa informação e use ela para pegar todos os movimentos da contaId passada
        //e exiba no console log pra começar
        async function listarMovimentos () {
			const urlParams =  new URLSearchParams(location.search);
			let contaId = urlParams.get('contaId');
			const movimentos = await getMovimentosDaConta(contaId);
			console.log('movimentos', movimentos);
            renderListaMovimentos(movimentos);
		}

       async function getMovimentosDaConta (contaId) {
            let headers = new Headers();
            headers.append(
                "Authorization",
                window.localStorage.getItem("token_awt")
            );

            let listaMovimentos = {};

            listaMovimentos = await fetch(`http://localhost:8000/movimentos?contaId=${contaId}`, {
                method: 'get',
                body: null,
                headers: headers,
            })
            .then(async(response) => {
                let text = await response.text();
                try {
                    console.log("debug antes de converter: ", text);
                    let objetoJS = JSON.parse(text);

                    if (response.ok) {
                        return objetoJS.data.movimentos;
                    }

                   alert("erro! " + objetoJS.data.mensagem);
                   if (response.status == "401") {
                       window.location.href = "index.html";
                   }
                   
                } catch (error) {
                    console.log("pau na conversao... dados:", text);
                    alert("erro na conversao! veja console log");
                    console.error(error);
                }
            })
            .catch((error) => console.log(error));

			return listaMovimentos;
        };

        function renderListaMovimentos(listaMovimentos) {
            let divListaMovimentos = document.getElementById("divListaMovimentos");
            let html = "";
            console.log(listaMovimentos);
            listaMovimentos.forEach((movimentos) => {
                // let actions = getActions(movimentos.id);

                html += `<tr>
                    <td>${movimentos.id}</td>
                    <td>${movimentos.descricao}</td>
                    <td>${movimentos.valor}</td>
                    <td>${movimentos.tipo}</td>
                </tr>`;
            });
            console.log(html);
            divListaMovimentos.innerHTML = `<table class="table">${html}</table><h1>AMANHÃ VAMOS CRIAR O FORM PARA CRIAR NOVOS MOVIMENTOS NA CONTA</h1>`;
        }

		listarMovimentos();
    </script>
    </body>
</html>
